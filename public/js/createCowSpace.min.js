Detector.webgl||Detector.addGetWebGLMessage();var hash=document.location.hash.substr(1);hash&&(hash=parseInt(hash,0));var WIDTH=hash||128,NUM_TEXELS=WIDTH*WIDTH,BOUNDS=512,BOUNDS_HALF=0.5*BOUNDS,container,stats,camera,scene,renderer,controls,mouseMoved=!1,raycaster=new THREE.Raycaster,mouseCoords=new THREE.Vector2,objects=[],geometry,waterMesh,meshRay,gpuCompute,heightmapVariable,waterUniforms,smoothShader,camPosZ=0,simplex=new SimplexNoise,raycaster2=new THREE.Raycaster,mouse=new THREE.Vector2,windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,sunPivot=new THREE.Object3D,cube,cubeOrb=0;const overlay=document.getElementById("overlay"),zoom=document.getElementById("zoom"),phone=document.getElementById("phone-bar"),noSupport=document.getElementById("no-support");let loadingBar=document.getElementById("loading-bar"),loadingPercentage=document.getElementById("bar-percentage");document.getElementById("waterSize").innerText=WIDTH+" x "+WIDTH;function change(a){return location.hash=a,location.reload(),!1}for(var j,options="",i=4;10>i;i++)j=Math.pow(2,i),options+="<a href=\"#\" onclick=\"return change("+j+")\">"+j+"x"+j+"</a> ";document.getElementById("options").innerHTML=options,init(),Detector.webgl?animate():noSupport.style.display="flex";var LOADING_MANAGER=null;function init(){function c(W){"press"===W.type&&(Q?(zoomPhone.style.display="flex",controls.minDistance=48,controls.maxDistance=7500,camera.position.set(0,480,1050),controls.enablePan=!1,controls.enableRotate=!1):(zoomPhone.style.display="none",controls.minDistance=400,controls.maxDistance=1500,controls.enablePan=!0,controls.enableRotate=!0))}container=document.createElement("div"),document.body.appendChild(container),camera=new THREE.PerspectiveCamera(85,window.innerWidth/window.innerHeight,1,4500),camera.position.set(0,480,1050),scene=new THREE.Scene;var f=new THREE.LoadingManager;f.onLoad=function(){setTimeout(function(){overlay.style.display="none"},500)};var g=new THREE.DirectionalLight(16777215,0.6);g.position.set(300,400,175),scene.add(g);var h=new THREE.DirectionalLight(16121850,0.6);h.position.set(-100,350,-200),scene.add(h);var k=new THREE.DirectionalLight(16121850,0.6);k.position.set(-100,-100,200),scene.add(k),renderer=new THREE.WebGLRenderer,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDampning=!0,controls.minDistance=400,controls.maxDistance=1500;var u=new THREE.SphereGeometry(60,50,30),v=new THREE.MeshBasicMaterial({color:11040953,wireframe:!0}),w=new THREE.SphereGeometry(0.1,2,30),A=new THREE.MeshBasicMaterial({}),B=new THREE.Mesh(w,A);scene.add(B),B.position.y=-10,B.add(sunPivot),cube=new THREE.Mesh(u,v),cube.position.z=500,cube.position.y=550;cube.orbPos={z:0,y:0,x:0},sunPivot.orb={y:0.01},sunPivot.add(cube),objects.push(cube);var G=new THREE.JSONLoader(f);G.load("models/milkIslands2.json",function(W,X){var X=new THREE.MeshBasicMaterial({color:0}),Y=new THREE.Mesh(W,X);scene.add(Y),Y.position.z=-20,Y.position.x=10,Y.scale.set(30,30,30)},function(W){if(W.lengthComputable){var X=100*(W.loaded/W.total);loadingBar.style.width=Math.round(X)+"%",loadingPercentage.innerHTML=Math.round(X)+"%"}});var H=new THREE.JSONLoader(f);H.load("models/milkRaid.json",function(W,X){var X=new THREE.MeshPhongMaterial({color:11040953,shininess:200}),Y=new THREE.Mesh(W,X);scene.add(Y),Y.position.z=-140,Y.position.y=-240,Y.position.x=-170,Y.scale.set(1.15,1.15,1.15)});for(var K,I=new THREE.Geometry,J=0;1e4>J;J++)K=new THREE.Vector3,K.x=THREE.Math.randFloatSpread(2400),K.y=THREE.Math.randFloatSpread(2400),K.z=THREE.Math.randFloatSpread(2400),I.vertices.push(K);var L=new THREE.PointsMaterial({color:268435455}),M=new THREE.Points(I,L);scene.add(M);var J=0,O=new Hammer(phone);O.on("panleft panright tap press",function(W){c(W)}),document.addEventListener("keydown",function(W){32===W.keyCode&&(Q?(zoom.style.display="flex",controls.minDistance=48,controls.maxDistance=7500,camera.position.set(0,480,1050),controls.enablePan=!1,controls.enableRotate=!1):(zoom.style.display="none",controls.minDistance=400,controls.maxDistance=1500,controls.enablePan=!0,controls.enableRotate=!0))},!1),document.addEventListener("keydown",function(W){71===W.keyCode&&(cube.orbPos.z-=1)},!1),sunPivot.rotation.y=0;var P,Q=!0,R=function(){requestAnimationFrame(R),sunPivot.orb={y:0.01},sunPivot.rotation.y+=sunPivot.orb.y,P=0,P+=sunPivot.rotation.y,M.rotation.y+=1e-3,cube.position.z+=cube.orbPos.z,cube.position.z+=cubeOrb,cube.position.y+=cube.orbPos.y,!Q&&camera.position.z<=controls.minDistance&&(camera.position.z=controls.maxDistance-950,camera.position.y=2780),!Q&&camera.position.z>=controls.maxDistance-700&&(camera.position.z=controls.minDistance+50,camera.position.y=45),0>=cube.position.z&&(cube.position.z=0,sunPivot.rotation.y=0,cube.orbPos.y-=J,setInterval(function(){J+=0.0098},300),27>cube.scale.y&&cube.scale.set(1+J/50,1+J/50,1+J/50),0>=cube.position.y&&cube.material.color.setHex(11040953*(J+1))),-50>=cube.position.y&&0>=cube.position.z&&(cube.position.y=-50,cube.orbPos.y=0),cube.rotation.x+=9e-3,cube.rotation.y+=1e-3,cube.rotation.z+=1e-3,controls.update()};Detector.webgl?R():noSupport.style.display="flex",container.addEventListener("click",onDocumentMouseDown,!1),container.addEventListener("mousemove",onDocumentMouseMove,!1),container.addEventListener("touchstart",onDocumentTouchStart,!1),container.addEventListener("touchmove",onDocumentTouchMove,!1),document.addEventListener("keydown",function(W){87===W.keyCode&&(waterMesh.material.wireframe=!waterMesh.material.wireframe,waterMesh.material.needsUpdate=!0)},!1),window.addEventListener("resize",onWindowResize,!1);var S=new dat.GUI,T={mouseSize:10,viscosity:8e-3},U=function(){heightmapVariable.material.uniforms.mouseSize.value=T.mouseSize,heightmapVariable.material.uniforms.viscosityConstant.value=T.viscosity};S.add(T,"mouseSize",1,100,1).onChange(U),S.add(T,"viscosity",0,0.1,1e-3).onChange(U);S.add({smoothWater:function(){smoothWater()}},"smoothWater"),initWater(),U()}function initWater(){var b=new THREE.PlaneBufferGeometry(BOUNDS,BOUNDS,WIDTH-1,WIDTH-1),c=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{heightmap:{value:null}}]),vertexShader:document.getElementById("waterVertexShader").textContent,fragmentShader:THREE.ShaderChunk.meshphong_frag});c.lights=!0,c.color=new THREE.Color(16777215),c.specular=new THREE.Color(16777215),c.shininess=50,c.uniforms.diffuse.value=c.color,c.uniforms.specular.value=c.specular,c.uniforms.shininess.value=Math.max(c.shininess,1e-4),c.uniforms.opacity.value=c.opacity,c.defines.WIDTH=WIDTH.toFixed(1),c.defines.BOUNDS=BOUNDS.toFixed(1),waterUniforms=c.uniforms,waterMesh=new THREE.Mesh(b,c),waterMesh.rotation.x=-Math.PI/2,waterMesh.matrixAutoUpdate=!1,waterMesh.updateMatrix(),scene.add(waterMesh);var d=new THREE.PlaneBufferGeometry(BOUNDS,BOUNDS,1,1);meshRay=new THREE.Mesh(d,new THREE.MeshBasicMaterial({color:16777215,visible:!1})),meshRay.rotation.x=-Math.PI/2,meshRay.matrixAutoUpdate=!1,meshRay.updateMatrix(),scene.add(meshRay),gpuCompute=new GPUComputationRenderer(WIDTH,WIDTH,renderer);var e=gpuCompute.createTexture();fillTexture(e),heightmapVariable=gpuCompute.addVariable("heightmap",document.getElementById("heightmapFragmentShader").textContent,e),gpuCompute.setVariableDependencies(heightmapVariable,[heightmapVariable]),heightmapVariable.material.uniforms.mousePos={value:new THREE.Vector2(1e4,1e4)},heightmapVariable.material.uniforms.mouseSize={value:20},heightmapVariable.material.uniforms.viscosityConstant={value:0.03},heightmapVariable.material.defines.BOUNDS=BOUNDS.toFixed(1);var f=gpuCompute.init();null!==f&&console.error(f),smoothShader=gpuCompute.createShaderMaterial(document.getElementById("smoothFragmentShader").textContent,{texture:{value:null}})}function fillTexture(a){function b(l,m){for(var q=c,s=0.025,t=0,u=0;15>u;u++)t+=q*simplex.noise(l*s,m*s),q*=0.53+0.025*u,s*=1.25;return t}for(var c=10,d=a.image.data,e=0,f=0;f<WIDTH;f++)for(var g=0;g<WIDTH;g++){var h=128*g/WIDTH,k=128*f/WIDTH;d[e+0]=b(h,k,123.4),d[e+1]=0,d[e+2]=0,d[e+3]=1,e+=4}}function smoothWater(){for(var a=gpuCompute.getCurrentRenderTarget(heightmapVariable),b=gpuCompute.getAlternateRenderTarget(heightmapVariable),c=0;10>c;c++)smoothShader.uniforms.texture.value=a.texture,gpuCompute.doRenderTarget(smoothShader,b),smoothShader.uniforms.texture.value=b.texture,gpuCompute.doRenderTarget(smoothShader,a)}smoothWater();function onWindowResize(){windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function setMouseCoords(a,b){mouseCoords.set(2*(a/renderer.domElement.clientWidth)-1,2*-(b/renderer.domElement.clientHeight)+1),mouseMoved=!0}function onDocumentMouseMove(a){setMouseCoords(a.clientX,a.clientY)}function onDocumentMouseDown(a){setMouseCoords(a.clientX,a.clientY),raycaster2.setFromCamera(mouse,camera);var b=raycaster.intersectObjects(sunPivot.children);0<b.length&&(cubeOrb=-1,cube.material.color.setHex(16777215))}function onDocumentTouchStart(a){1===a.touches.length&&(a.preventDefault(),setMouseCoords(a.touches[0].pageX,a.touches[0].pageY))}function onDocumentTouchMove(a){1===a.touches.length&&(a.preventDefault(),setMouseCoords(a.touches[0].pageX,a.touches[0].pageY))}function animate(){requestAnimationFrame(animate),render()}function render(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini| SAMSUNG|Samsung|SGH-[I|N|T]|GT-[I|N]|SM-[N|P|T|Z]|SHV-E|SCH-[I|J|R|S]|SPH-L/i.test(navigator.userAgent)){raycaster2.setFromCamera(mouse,camera);var a=raycaster.intersectObjects(sunPivot.children);0<a.length&&(cubeOrb=-1,cube.material.color.setHex(16777215))}var b=heightmapVariable.material.uniforms;if(mouseMoved){this.raycaster.setFromCamera(mouseCoords,camera);var c=this.raycaster.intersectObject(meshRay);if(0<c.length&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini| SAMSUNG|Samsung|SGH-[I|N|T]|GT-[I|N]|SM-[N|P|T|Z]|SHV-E|SCH-[I|J|R|S]|SPH-L/i.test(navigator.userAgent)){var d=c[0].point;b.mousePos.value.set(d.x,d.z)}else if(0<c.length){var d=c[0].point;b.mousePos.value.set(d.x,d.z)}else b.mousePos.value.set(1e4,1e4);mouseMoved=!1}else b.mousePos.value.set(1e4,1e4);gpuCompute.compute(),waterUniforms.heightmap.value=gpuCompute.getCurrentRenderTarget(heightmapVariable).texture,renderer.render(scene,camera)}
